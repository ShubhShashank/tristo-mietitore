#!/bin/bash

echocol() { echo -ne "\033[31m$@...\033[0m "; }

export PYTHONPATH=.
export EEGNG_SETTINGS=$(pwd)/etc/test_conf.py

pg() { python -c "from urllib2 import urlopen; print urlopen( 'http://localhost:8000/$1' ).read()" | python; }

rm -rf /tmp/eeg_test
mkdir -p /tmp/eeg_test/{home,uploads}

killall python 2>/dev/null
python -m eegat.web prod > /tmp/eeg_test/out 2> /tmp/eeg_test/err &
sleep 2

echocol Successful sign

if [ "$(pg 1)" == 'echo "Effettuata installazione in /tmp/eeg_test/home per: First"; echo "TESTCONF"' ]; then
	echo OK
else
	echo FAIL
fi

echocol Download

rm -f /tmp/eeg_test/home/TEST
/tmp/eeg_test/home/.eeg dl
if [ -r /tmp/eeg_test/home/TEST ]; then
	echo OK
else
	echo FAIL
fi

echocol Repeated sign

if [ "$(pg 1)" == 'echo "Matricola già in uso per lo studente: First"' ]; then
	echo OK
else
	echo FAIL
fi

echocol Not registered

if [ "$(pg x)" == "echo \"Matricola non registrata all'esame\"" ]; then
	echo OK
else
	echo FAIL
fi

echocol Upload

if [ "$(/tmp/eeg_test/home/.eeg ul ^TEST)" == "TEST" ]; then
	echo OK
else
	echo FAIL
fi

echocol Client error

perl -i -pe 's/49a4405aafe63df05202df08f8f75c9247b7168159c964f697ba6f974ae40588/boo/' /tmp/eeg_test/home/.eeg
if [ "$(/tmp/eeg_test/home/.eeg ul ^TEST 2>&1)" == "Si è verificato un errore inatteso del cliernt!" ]; then
	echo OK
else
	echo FAIL
fi

echocol Bootstrap failure

touch /tmp/eeg_test/uploads/s
if [ "$(pg s)" == 'echo "Si è verificato un errore inatteso di avvio!"' ]; then
	echo OK
else
	echo FAIL
fi

echocol Installation failure

rm /tmp/eeg_test/uploads/s
rm -rf /tmp/eeg_test/home
if [ "$(pg s 2>&1)" == 'Si è verificato un errore inatteso di installazione!' ]; then
	echo OK
else
	echo FAIL
fi

echocol Auth error

if [ "$(curl -d signature=x -sL http://localhost:8000/)" == '# Firma mancante, o invalida!' ]; then
	echo OK
else
	echo FAIL
fi

echocol Internal error

if [ "$(curl -d signature='s:31aa7ab3db1f26dae9daf68f664c242d4c9adbcef36506c134c3eed4573f7bdc' -d tar='ERROR' -sL http://localhost:8000/)" == '# Si è verificato un errore inatteso del server!' ]; then
	echo OK
else
	echo FAIL
fi

killall python 2>/dev/null
